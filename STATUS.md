# Backend Development Status

This document tracks the progress of the Tagline backend (FastAPI) implementation. Each milestone below represents a major step toward a robust, production-ready API.

## Current Status

- [x] Set up CI for automated testing
- [x] Scaffold minimal FastAPI application
- [x] Integrate persistent storage (database)
    - [x] Choose database library/ORM (e.g., SQLAlchemy)
    - [x] Add environment variable for DB connection string (`DATABASE_URL`)
        - [x] If not set, default to SQLite file (e.g., `sqlite:///./tagline.db`)
        - [x] Document this in README and .env.example
    - [x] Implement database connection logic in FastAPI app
        - [x] Read connection string from env/config
        - [x] Configure SQLAlchemy engine/session accordingly
        - [x] Handle SQLite-specific options (e.g., check_same_thread)
    - [x] Define database schema/models:
        - [x] Photo metadata (ID, filename, description, timestamps, etc.)
        - [x] Refresh tokens (for revocation/token store)
    - [x] Set up database session dependency injection for FastAPI routes
        - [x] Implemented `get_db` dependency in `tagline_backend_app/db/session.py`. Ready for use in all future FastAPI routes.
    - [x] Implement migrations (e.g., Alembic)
        - [x] Create initial migration scripts
        - [x] Document migration workflow
    - [x] Write CRUD utility functions/repositories for:
        - [x] Photo metadata
        - [x] Refresh tokens
    - [x] Document database setup, connection string usage, and defaults
- [x] Add file storage for photos
    - [x] Define a storage provider interface/abstract base class (e.g., `PhotoStorageProvider`)
        - [x] Specify required methods: list, retrieve, maybe etc.
    - [x] Implement local filesystem provider (MVP)
        - [x] Store photos in a configurable directory (env var, e.g., `FILESYSTEM_STORAGE_PATH`)
    - [x] Implement provider selection logic
        - [x] Add environment variable to select storage provider (e.g., `STORAGE_PROVIDER=filesystem`)
        - [x] Load/configure provider at app startup based on env/config
        - [x] Document this in README and .env.example
    - [x] (Optional) Stub out cloud provider (e.g., Dropbox/S3/MinIO) for future use
        - [x] Add config/env vars for remote provider
        - [x] Implement provider skeleton (can raise NotImplementedError for now)
    - [x] Add unit tests for provider interface and local implementation
    - [x] Document provider interface, config, and extension points
    - [x] Implement Dropbox provider (refresh token flow)
        - [x] Update config and documentation
        - [x] Add unit tests
        - [x] Legacy access token is deprecated
- [ ] Add authentication and authorization
    - [x] Integration/E2E test suite structure and methodology finalized
    - [x] All tests (unit, integration, E2E) passing in CI, with enforced linting and formatting
    - [x] Design and implement refresh token store for revocation
        - [x] Remove all legacy DB models, migrations, and code for refresh tokens (now Redis-only)
        - [x] DB schema is clean: no more refresh_tokens table
        - [x] Backend is 100% Redis-powered for refresh token storage
        - [x] Choose storage backend (in-memory, file, or database)
        - [x] Store issued refresh tokens with status/expiration
        - [x] Check token validity on each refresh
        - [x] Implement revocation (blacklist/delete)
        - [x] Unit test: token issuance, validation, revocation
        - [x] E2E test: revoked token cannot be used
    - [x] Implement password-based authentication
        - [x] Add `BACKEND_PASSWORD` to environment/config
        - [x] Define `LoginRequest` and `LoginResponse` Pydantic models
        - [x] Create `auth_service.py` with functions for:
            - [x] Verifying password
            - [x] Issuing access and refresh tokens (with expiry)
            - [x] Validating tokens
            - [x] Revoking refresh tokens
        - [x] Unit test: service logic (password, token issuance, validation, revocation)
    - [x] Implement JWT access and refresh tokens
        - [x] Generate short-lived access tokens (JWT)
        - [x] Generate long-lived refresh tokens (JWT)
        - [x] Store JWT secret in env/config
        - [x] Add token expiration and refresh logic
        - [x] Unit test: token creation/validation/expiration
    - [x] Protect endpoints with authentication
        - [x] Require access token for all protected endpoints (see /photos, /photos/{id}, /photos/{id}/image, /photos/{id}/metadata)
        - [x] Implement token validation in FastAPI dependencies (now uses HTTPBearer and OpenAPI security)
        - [x] Return 401/403 for missing/invalid tokens (fully tested)
        - [x] Unit test: unauthorized access (see tests/unit/)
        - [x] E2E test: endpoint protection (see tests/e2e/, all scenarios passing as of 2025-04-25)
        - [x] Swagger UI now supports Bearer token authentication via "Authorize" button
        - [x] GET /photos/{id} and /photos/{id}/image now fully protected and tested (unit/E2E)
    - [ ] Implement logout/invalidate refresh tokens (optional for MVP)
        - [ ] Add refresh token blacklist or revocation mechanism (if needed)
        - [x] Unit/E2E test: revoked token cannot be used
    - [ ] Document authentication flow and error responses
- [ ] Implement core API endpoints
    - [x] POST /login — Authenticate, get tokens
        - [x] Add validation for login payload (password required, type)
        - [x] Unit test: valid/invalid login payloads
        - [x] E2E test: endpoint behavior
    - [x] POST /refresh — Get new access token
        - [x] Define `RefreshRequest` and `RefreshResponse` models
        - [x] Add validation for refresh payload (refresh_token required, type)
        - [x] Unit test: valid/invalid refresh payloads
        - [x] E2E test: endpoint behavior
    - [x] GET /photos — List photo IDs (paginated)
        - [x] Define `PhotoListResponse` model
        - [x] Add validation for query params (limit, offset)
        - [x] Unit test: valid/invalid pagination params
        - [x] E2E test: endpoint behavior
    - [x] GET /photos/{id} — Get photo + metadata
        - [x] Define `Photo` model
        - [x] Add validation for path param (UUID format)
        - [x] Unit test: valid/invalid photo ID
        - [x] E2E test: endpoint behavior
    - [x] PATCH /photos/{id}/metadata — Update metadata (description)
        - [x] Define `UpdateMetadataRequest` model
        - [x] Add validation for description and last_modified (empty string allowed)
        - [x] Unit test: valid/invalid metadata payloads (including empty desc, invalid last_modified)
        - [x] Integration test: real DB + in-memory storage provider (see tests/integration/test_patch_photo_metadata_integration.py)
        - [x] E2E test: endpoint behavior (see tests/e2e/test_patch_photo_metadata_e2e.py, all scenarios passing as of 2025-04-25)
    - [x] GET /photos/{id}/image — Get image file
        - [x] Define response model or headers (content-type, etc.)
        - [x] Add validation for path param (UUID format)
        - [x] Unit test: valid/invalid photo ID (see tests/unit/test_get_photo_image.py)
        - [x] E2E test: endpoint behavior (see tests/e2e/test_get_photo_image_e2e.py, all scenarios passing as of 2025-04-25)
    - [x] POST /rescan — Scan storage, import new photos
        - [x] Define response model if needed
        - [x] Validate triggering conditions
        - [x] Unit test: endpoint behavior
        - [x] E2E/integration test: endpoint behavior (integration-scale tests implemented)
- [x] Add API documentation and OpenAPI schema customizations
- [ ] Improve error handling and logging
- [ ] Performance and security review
- [ ] Production readiness checklist

## Last Updated
2025-04-25 (all protected endpoints, including /photos/{id} and /photos/{id}/image, now require Bearer token; E2E/unit tests passing)

---

Want to help? See the project spec in `infra/SPEC.md` for details and priorities.
